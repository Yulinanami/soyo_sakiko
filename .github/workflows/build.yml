name: Build Release

on:
  release:
    types: [published]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: 安装前端依赖
        working-directory: frontend
        run: npm ci

      - name: 构建前端
        working-directory: frontend
        env:
          VITE_API_BASE: http://127.0.0.1:8000/api
          VITE_API_URL: http://127.0.0.1:8000/api
        run: npm run build

      - name: 上传前端产物
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  build-backend:
    needs: build-frontend
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: x64-windows
            archive_cmd: 7z a SoyoSaki-${{ github.ref_name }}-x64-windows.zip "SoyoSaki-${{ github.ref_name }}"
            archive_file: SoyoSaki-${{ github.ref_name }}-x64-windows.zip
            playwright_install: chromium
          - os: ubuntu-22.04
            platform: x64-linux
            archive_cmd: tar -czf SoyoSaki-${{ github.ref_name }}-x64-linux.tar.gz "SoyoSaki-${{ github.ref_name }}"
            archive_file: SoyoSaki-${{ github.ref_name }}-x64-linux.tar.gz
            playwright_install: --with-deps chromium
          - os: macos-14
            platform: arm64-macos
            archive_cmd: tar -czf SoyoSaki-${{ github.ref_name }}-arm64-macos.tar.gz "SoyoSaki-${{ github.ref_name }}"
            archive_file: SoyoSaki-${{ github.ref_name }}-arm64-macos.tar.gz
            playwright_install: chromium

    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: 安装后端依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pyinstaller

      - name: 安装浏览器内核
        env:
          PLAYWRIGHT_BROWSERS_PATH: backend/playwright-browsers
        run: python -m playwright install ${{ matrix.playwright_install }}

      - name: 复制后端启动脚本
        run: cp .github/scripts/run_backend.py backend/run_backend.py

      - name: 修正 Frozen 环境下的 Env 路径
        run: python .github/scripts/patch_frozen_env.py

      - name: 构建后端
        run: |
          pyinstaller \
            --noconfirm --clean --onedir --console \
            --name SoyoSaki \
            --collect-all playwright \
            --collect-submodules app \
            --collect-submodules passlib \
            --hidden-import app.main \
            --hidden-import passlib.handlers.bcrypt \
            backend/run_backend.py --paths backend

      - name: 下载前端产物
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend-dist

      - name: 组装产物
        run: |
          APP_DIR="release/SoyoSaki-${{ github.ref_name }}"
          mkdir -p "$APP_DIR"
          cp -R backend/playwright-browsers dist/SoyoSaki/playwright-browsers
          cp -R dist/SoyoSaki/* "$APP_DIR/"
          cp -R frontend-dist "$APP_DIR/frontend"
          cp backend/.env.example "$APP_DIR/.env"
          cd release
          ${{ matrix.archive_cmd }}

      - name: 上传产物
        uses: softprops/action-gh-release@v2
        with:
          files: release/${{ matrix.archive_file }}
