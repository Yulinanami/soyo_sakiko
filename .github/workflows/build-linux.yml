name: build-linux

on:
  release:
    types: [published]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: 安装前端依赖
        working-directory: frontend
        run: npm ci

      - name: 构建前端
        working-directory: frontend
        env:
          VITE_API_BASE: http://127.0.0.1:8000/api
          VITE_API_URL: http://127.0.0.1:8000/api
        run: npm run build

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: 安装后端依赖
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pyinstaller

      - name: 安装浏览器内核
        env:
          PLAYWRIGHT_BROWSERS_PATH: backend/playwright-browsers
        run: python -m playwright install --with-deps chromium

      - name: 复制后端启动脚本
        run: cp .github/scripts/run_backend.py backend/run_backend.py

      - name: 修正 Frozen 环境下的 Env 路径
        run: python .github/scripts/patch_frozen_env.py

      - name: 构建后端
        run: |
          pyinstaller --noconfirm --clean --onedir --console --name SoyoSaki --collect-all playwright --collect-submodules app --collect-submodules passlib --hidden-import app.main --hidden-import passlib.handlers.bcrypt backend/run_backend.py --paths backend

      - name: 组装产物
        run: |
          APP_DIR="release/SoyoSaki-${{ github.ref_name }}"
          mkdir -p "$APP_DIR"
          cp -R backend/playwright-browsers dist/SoyoSaki/playwright-browsers
          cp -R dist/SoyoSaki/* "$APP_DIR/"
          cp -R frontend/dist "$APP_DIR/frontend"
          cp backend/.env.example "$APP_DIR/.env"
          cd release
          tar -czf SoyoSaki-${{ github.ref_name }}-x64-linux.tar.gz "SoyoSaki-${{ github.ref_name }}"

      - name: 上传产物
        uses: softprops/action-gh-release@v2
        with:
          files: release/SoyoSaki-${{ github.ref_name }}-x64-linux.tar.gz
